<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quy√™n g√≥p Blockchain - Sepolia</title>
    <style>
        /* --- GIAO DI·ªÜN ƒê·∫∏P --- */
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; text-align: center; padding: 20px; background-color: #f4f6f8; color: #333; }
        .container { background: white; padding: 30px; border-radius: 16px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); max-width: 650px; margin: auto; }
        
        h2 { color: #2c3e50; margin-bottom: 5px; }
        p.subtitle { color: #7f8c8d; margin-top: 0; font-size: 0.9em; }

        input, button, textarea { width: 100%; padding: 12px; margin: 8px 0; border-radius: 8px; border: 1px solid #ddd; box-sizing: border-box; font-size: 1em; }
        
        button { cursor: pointer; font-weight: bold; border: none; transition: 0.3s; }
        .btn-primary { background-color: #007bff; color: white; }
        .btn-primary:hover { background-color: #0056b3; }
        .btn-danger { background-color: #dc3545; color: white; }
        
        .hidden { display: none !important; }

        /* Th√¥ng tin v√≠ */
        .info-box { background: #e9f7ef; padding: 15px; border-radius: 10px; margin-bottom: 20px; border: 1px solid #c3e6cb; text-align: left; }
        .info-row { display: flex; justify-content: space-between; margin-bottom: 5px; }
        .highlight { color: #28a745; font-weight: bold; font-size: 1.1em; }

        /* Admin Panel */
        #adminSection { background-color: #fff3cd; padding: 20px; border-radius: 10px; border: 1px solid #ffeeba; margin-top: 30px; text-align: left; }

        /* B·∫£ng l·ªãch s·ª≠ */
        .table-wrapper { overflow-x: auto; max-height: 400px; overflow-y: auto; border-radius: 8px; border: 1px solid #eee; margin-top: 10px;}
        table { width: 100%; border-collapse: collapse; font-size: 0.9em; }
        th { background-color: #f8f9fa; position: sticky; top: 0; z-index: 10; font-weight: 600; }
        th, td { padding: 12px 15px; border-bottom: 1px solid #eee; text-align: left; }
        
        .address { color: #007bff; font-family: monospace; background: #f0f8ff; padding: 2px 6px; border-radius: 4px; }
        .my-row { background-color: #f0fff4; } /* T√¥ m√†u d√≤ng c·ªßa m√¨nh */
        
        /* B·ªô l·ªçc */
        .filter-container { display: flex; gap: 10px; align-items: center; margin-top: 20px;}
    </style>
</head>
<body>

    <div class="container">
        <h2>üöÄ Qu·ªπ C·ªông ƒê·ªìng (Sepolia)</h2>
        <p class="subtitle">K·∫øt n·ªëi v√≠ ƒë·ªÉ tr·∫£i nghi·ªám Hardhat Deploy</p>
        
        <button id="connectBtn" class="btn-primary" style="padding: 15px; font-size: 1.1em;">üîå K·∫øt n·ªëi v√≠ MetaMask</button>

        <div id="appSection" class="hidden">
            
            <div class="info-box">
                <div class="info-row">
                    <span>üë§ V√≠ c·ªßa b·∫°n:</span>
                    <span id="walletAddress" style="font-weight:bold; font-family: monospace">...</span>
                </div>
                <div class="info-row">
                    <span>üí∞ T·ªïng qu·ªπ:</span>
                    <span class="highlight"><span id="totalFund">0</span> ETH</span>
                </div>
            </div>

            <div style="text-align: left;">
                <h3 style="margin-bottom: 10px;">üíñ G·ª≠i t·∫•m l√≤ng</h3>
                <input type="number" id="amount" placeholder="S·ªë ti·ªÅn (ETH) - VD: 0.001" step="0.0001">
                <textarea id="message" placeholder="Vi·∫øt l·ªùi nh·∫Øn..." rows="2"></textarea>
                <button id="donateBtn" class="btn-primary">G·ª≠i Quy√™n G√≥p üöÄ</button>
                <p id="status" style="margin-top: 10px; font-weight: bold; text-align: center; min-height: 20px;"></p>
            </div>

            <div id="adminSection" class="hidden">
                <h3>üîê Admin Panel</h3>
                <p style="font-size: 0.9em;">B·∫°n l√† ch·ªß s·ªü h·ªØu contract n√†y.</p>
                <input type="text" id="withdrawAddress" placeholder="ƒê·ªãa ch·ªâ v√≠ nh·∫≠n ti·ªÅn..." style="background: white;">
                <button id="withdrawBtn" class="btn-danger">üí∏ R√∫t to√†n b·ªô qu·ªπ</button>
            </div>

            <hr style="margin: 30px 0; border: 0; border-top: 1px solid #eee;">

            <h3 style="text-align: left;">üìú L·ªãch s·ª≠ giao d·ªãch</h3>
            <div class="filter-container">
                <input type="text" id="searchInput" placeholder="üîç T√¨m v√≠ ho·∫∑c l·ªùi nh·∫Øn..." style="flex:1;">
                <label style="white-space: nowrap; cursor: pointer;">
                    <input type="checkbox" id="myDonationFilter"> Ch·ªâ hi·ªán c·ªßa t√¥i
                </label>
            </div>

            <div class="table-wrapper">
                <table id="donationTable">
                    <thead>
                        <tr>
                            <th>Ng∆∞·ªùi g·ª≠i</th>
                            <th>ETH</th>
                            <th>L·ªùi nh·∫Øn</th>
                            <th>Th·ªùi gian</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody"></tbody>
                </table>
            </div>
        </div>
    </div>

    <script type="module">
        import { ethers } from "https://cdnjs.cloudflare.com/ajax/libs/ethers/6.7.0/ethers.min.js";

        // ============================================================
        // üëá THAY ƒê·ªîI 2 D√íNG N√ÄY THEO TH√îNG TIN C·ª¶A B·∫†N üëá
        // ============================================================
        
        // 1. D√°n ƒë·ªãa ch·ªâ Contract m·ªõi deploy (0x648...)
        const CONTRACT_ADDRESS = "0xA09420e553B94790A811804c24eF69009b1CaDAF"; 

        // 2. M·ªü file: artifacts/contracts/Donation.sol/DonationDApp.json
        // Copy to√†n b·ªô ƒëo·∫°n "abi": [...] v√† d√°n v√†o d∆∞·ªõi ƒë√¢y
        const CONTRACT_ABI = [
    {
      "inputs": [],
      "stateMutability": "nonpayable",
      "type": "constructor"
    },
    {
      "anonymous": false,
      "inputs": [
        {
          "indexed": true,
          "internalType": "address",
          "name": "donor",
          "type": "address"
        },
        {
          "indexed": false,
          "internalType": "uint256",
          "name": "amount",
          "type": "uint256"
        },
        {
          "indexed": false,
          "internalType": "string",
          "name": "message",
          "type": "string"
        },
        {
          "indexed": false,
          "internalType": "uint256",
          "name": "timestamp",
          "type": "uint256"
        }
      ],
      "name": "NewDonation",
      "type": "event"
    },
    {
      "anonymous": false,
      "inputs": [
        {
          "indexed": true,
          "internalType": "address",
          "name": "previousOwner",
          "type": "address"
        },
        {
          "indexed": true,
          "internalType": "address",
          "name": "newOwner",
          "type": "address"
        }
      ],
      "name": "OwnershipTransferred",
      "type": "event"
    },
    {
      "inputs": [
        {
          "internalType": "string",
          "name": "_message",
          "type": "string"
        }
      ],
      "name": "donate",
      "outputs": [],
      "stateMutability": "payable",
      "type": "function"
    },
    {
      "inputs": [
        {
          "internalType": "uint256",
          "name": "",
          "type": "uint256"
        }
      ],
      "name": "donations",
      "outputs": [
        {
          "internalType": "address",
          "name": "donor",
          "type": "address"
        },
        {
          "internalType": "uint256",
          "name": "amount",
          "type": "uint256"
        },
        {
          "internalType": "uint256",
          "name": "timestamp",
          "type": "uint256"
        },
        {
          "internalType": "string",
          "name": "message",
          "type": "string"
        }
      ],
      "stateMutability": "view",
      "type": "function"
    },
    {
      "inputs": [],
      "name": "getDonations",
      "outputs": [
        {
          "components": [
            {
              "internalType": "address",
              "name": "donor",
              "type": "address"
            },
            {
              "internalType": "uint256",
              "name": "amount",
              "type": "uint256"
            },
            {
              "internalType": "uint256",
              "name": "timestamp",
              "type": "uint256"
            },
            {
              "internalType": "string",
              "name": "message",
              "type": "string"
            }
          ],
          "internalType": "struct DonationDApp.Donation[]",
          "name": "",
          "type": "tuple[]"
        }
      ],
      "stateMutability": "view",
      "type": "function"
    },
    {
      "inputs": [],
      "name": "owner",
      "outputs": [
        {
          "internalType": "address",
          "name": "",
          "type": "address"
        }
      ],
      "stateMutability": "view",
      "type": "function"
    },
    {
      "inputs": [],
      "name": "totalDonatedAmount",
      "outputs": [
        {
          "internalType": "uint256",
          "name": "",
          "type": "uint256"
        }
      ],
      "stateMutability": "view",
      "type": "function"
    },
    {
      "inputs": [
        {
          "internalType": "address",
          "name": "newOwner",
          "type": "address"
        }
      ],
      "name": "transferOwnership",
      "outputs": [],
      "stateMutability": "nonpayable",
      "type": "function"
    },
    {
      "inputs": [
        {
          "internalType": "address payable",
          "name": "_to",
          "type": "address"
        }
      ],
      "name": "withdrawTo",
      "outputs": [],
      "stateMutability": "nonpayable",
      "type": "function"
    }
  ];
        // ============================================================

        let provider, signer, contract;
        let allDonations = [];
        let currentSignerAddr = "";

        // UI Elements
        const connectBtn = document.getElementById("connectBtn");
        const appSection = document.getElementById("appSection");
        const statusTxt = document.getElementById("status");
        const walletTxt = document.getElementById("walletAddress");
        
        // --- K·∫æT N·ªêI V√ç ---
        connectBtn.onclick = async () => {
            if (window.ethereum) {
                try {
                    // 1. Y√™u c·∫ßu quy·ªÅn truy c·∫≠p
                    await window.ethereum.request({ method: "eth_requestAccounts" });
                    
                    // 2. √âP BU·ªòC CHUY·ªÇN SANG M·∫†NG SEPOLIA
                    try {
                        await window.ethereum.request({
                            method: 'wallet_switchEthereumChain',
                            params: [{ chainId: '0xaa36a7' }], // 0xaa36a7 l√† m√£ Hex c·ªßa Sepolia (11155111)
                        });
                    } catch (switchError) {
                        // N·∫øu m·∫°ng Sepolia ch∆∞a ƒë∆∞·ª£c th√™m v√†o v√≠, th√¥ng b√°o l·ªói (th∆∞·ªùng MetaMask ƒë√£ c√≥ s·∫µn)
                        if (switchError.code === 4902) {
                            alert("Vui l√≤ng th√™m m·∫°ng Sepolia v√†o MetaMask c·ªßa b·∫°n!");
                        }
                    }

                    // 3. Kh·ªüi t·∫°o provider sau khi ƒë√£ chuy·ªÉn m·∫°ng ƒë√∫ng
                    provider = new ethers.BrowserProvider(window.ethereum);
                    signer = await provider.getSigner();
                    
                    // L·∫•y ƒë·ªãa ch·ªâ v√≠
                    currentSignerAddr = await signer.getAddress();
                    walletTxt.innerText = currentSignerAddr.substring(0, 6) + "..." + currentSignerAddr.slice(-4);
                    
                    // K·∫øt n·ªëi Contract
                    contract = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, signer);

                    // Hi·ªÉn th·ªã giao di·ªán
                    connectBtn.classList.add("hidden");
                    appSection.classList.remove("hidden");
                    statusTxt.innerText = "‚úÖ ƒê√£ k·∫øt n·ªëi m·∫°ng Sepolia!";
                    statusTxt.style.color = "green";
                    
                    loadData(); 

                } catch (error) {
                    console.error(error);
                    statusTxt.innerText = "‚ùå L·ªói: " + error.message;
                }
            } else {
                alert("Vui l√≤ng c√†i ƒë·∫∑t MetaMask!");
            }
        };

        // --- G·ª¨I TI·ªÄN (Quan tr·ªçng: C√≥ tham s·ªë Message) ---
        document.getElementById("donateBtn").onclick = async () => {
            const amount = document.getElementById("amount").value;
            const message = document.getElementById("message").value;

            if (!amount || !message) return alert("Vui l√≤ng nh·∫≠p ti·ªÅn v√† l·ªùi nh·∫Øn!");

            try {
                statusTxt.innerText = "‚è≥ ƒêang g·ª≠i transaction...";
                statusTxt.style.color = "blue";

                // G·ªçi h√†m donate v·ªõi 2 tham s·ªë: message v√† value (ti·ªÅn)
                const tx = await contract.donate(message, { value: ethers.parseEther(amount) });
                
                await tx.wait(); // ƒê·ª£i x√°c nh·∫≠n
                
                statusTxt.innerText = "‚úÖ Th√†nh c√¥ng!";
                statusTxt.style.color = "green";
                loadData(); // T·∫£i l·∫°i b·∫£ng
                
            } catch (e) {
                console.error(e);
                statusTxt.innerText = "‚ùå Th·∫•t b·∫°i: " + (e.reason || e.message);
                statusTxt.style.color = "red";
            }
        };

        // --- R√öT TI·ªÄN (ADMIN) ---
        document.getElementById("withdrawBtn").onclick = async () => {
            const dest = document.getElementById("withdrawAddress").value;
            try {
                const tx = await contract.withdrawTo(dest);
                await tx.wait();
                alert("R√∫t ti·ªÅn th√†nh c√¥ng!");
                loadData();
            } catch (e) { alert("L·ªói: " + e.message); }
        };

        // --- T·∫¢I D·ªÆ LI·ªÜU ---
        async function loadData() {
            try {
                // 1. L·∫•y t·ªïng ti·ªÅn
                const total = await contract.totalDonatedAmount();
                document.getElementById("totalFund").innerText = ethers.formatEther(total);

                // 2. L·∫•y danh s√°ch & Admin check
                const data = await contract.getDonations();
                allDonations = [...data];
                filterAndRender(); // V·∫Ω b·∫£ng

                // Ki·ªÉm tra Owner ƒë·ªÉ hi·ªán n√∫t R√∫t ti·ªÅn
                try {
                    const owner = await contract.owner();
                    if (owner.toLowerCase() === currentSignerAddr.toLowerCase()) {
                        document.getElementById("adminSection").classList.remove("hidden");
                    }
                } catch(e) {}

            } catch (e) { console.error("L·ªói load data", e); }
        }

        // --- B·ªò L·ªåC & V·∫º B·∫¢NG ---
        const searchInput = document.getElementById("searchInput");
        const myFilter = document.getElementById("myDonationFilter");

        function filterAndRender() {
            const keyword = searchInput.value.toLowerCase();
            const isMyOnly = myFilter.checked;

            const filtered = allDonations.filter(d => {
                const matchKey = d.donor.toLowerCase().includes(keyword) || d.message.toLowerCase().includes(keyword);
                const matchOwner = isMyOnly ? (d.donor.toLowerCase() === currentSignerAddr.toLowerCase()) : true;
                return matchKey && matchOwner;
            });

            const tbody = document.getElementById("tableBody");
            tbody.innerHTML = "";
            
            // Duy·ªát ng∆∞·ª£c ƒë·ªÉ tin m·ªõi nh·∫•t l√™n ƒë·∫ßu
            for (let i = filtered.length - 1; i >= 0; i--) {
                const d = filtered[i];
                const date = new Date(Number(d.timestamp) * 1000).toLocaleString();
                const isMine = d.donor.toLowerCase() === currentSignerAddr.toLowerCase();
                
                tbody.innerHTML += `
                    <tr class="${isMine ? 'my-row' : ''}">
                        <td><span class="address">${d.donor.substring(0,6)}...${d.donor.slice(-4)}</span></td>
                        <td style="font-weight:bold; color:green;">${ethers.formatEther(d.amount)}</td>
                        <td>${d.message}</td>
                        <td style="font-size:0.8em; color:#666;">${date}</td>
                    </tr>`;
            }
        }

        searchInput.addEventListener("input", filterAndRender);
        myFilter.addEventListener("change", filterAndRender);

    </script>
</body>
</html>