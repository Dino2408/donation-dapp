<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Crowdfunding Blockchain</title>
    <style>
        /* --- CSS CHUNG --- */
        body { font-family: 'Segoe UI', sans-serif; background: #f0f2f5; padding: 20px; text-align: center; color: #333; }
        .container { max-width: 1000px; margin: auto; }
        .hidden { display: none !important; }
        
        /* Button Styles */
        button { cursor: pointer; font-weight: bold; border: none; padding: 10px 20px; border-radius: 8px; transition: 0.3s; }
        .btn-primary { background: #007bff; color: white; }
        .btn-primary:hover { background: #0056b3; }
        .btn-danger { background: #dc3545; color: white; }
        .btn-secondary { background: #6c757d; color: white; }
        .btn-back { background: transparent; color: #555; border: 1px solid #ccc; float: left; margin-bottom: 10px; }
        .btn-back:hover { background: #eee; }

        input { padding: 10px; border: 1px solid #ddd; border-radius: 6px; width: 100%; box-sizing: border-box; margin-top: 5px; }

        /* --- M√ÄN H√åNH HOME (GRID VIEW) --- */
        .campaign-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px; margin-top: 20px; }
        .card { background: white; border-radius: 12px; overflow: hidden; box-shadow: 0 4px 10px rgba(0,0,0,0.05); transition: 0.3s; text-align: left; display: flex; flex-direction: column; cursor: pointer; }
        .card:hover { transform: translateY(-5px); box-shadow: 0 8px 20px rgba(0,0,0,0.1); }
        .card-img { width: 100%; height: 160px; object-fit: cover; }
        .card-body { padding: 20px; flex: 1; display: flex; flex-direction: column; }
        .badge { padding: 4px 8px; border-radius: 4px; font-size: 0.8em; float: right; color: white; }
        .badge.open { background: #28a745; } .badge.closed { background: #6c757d; }
        
        /* Progress Bar */
        .progress-container { background: #e9ecef; height: 8px; border-radius: 4px; margin: 15px 0; overflow: hidden; }
        .progress-bar { height: 100%; background: #28a745; width: 0%; transition: 1s; }

        /* --- M√ÄN H√åNH CHI TI·∫æT (DETAIL VIEW) --- */
        #detailView { background: white; padding: 30px; border-radius: 16px; box-shadow: 0 5px 20px rgba(0,0,0,0.1); text-align: left; }
        .detail-header { display: flex; gap: 20px; align-items: start; margin-bottom: 30px; flex-wrap: wrap; }
        .detail-img { width: 300px; height: 200px; object-fit: cover; border-radius: 10px; }
        .detail-info { flex: 1; }
        
        /* Dashboard T√†i ch√≠nh trong Detail */
        .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin: 20px 0; }
        .stat-box { background: #f8f9fa; padding: 15px; border-radius: 8px; border: 1px solid #eee; text-align: center; }
        .stat-val { display: block; font-size: 1.5em; font-weight: bold; color: #007bff; }

        /* B·∫£ng l·ªãch s·ª≠ */
        .table-wrapper { overflow-x: auto; margin-top: 20px; }
        table { width: 100%; border-collapse: collapse; font-size: 0.9em; }
        th, td { padding: 12px; border-bottom: 1px solid #eee; text-align: left; }
        th { background: #f8f9fa; }
        .tx-in { background: #f0fff4; } .tx-out { background: #fff5f5; }
        .money-in { color: #28a745; font-weight: bold; } .money-out { color: #dc3545; font-weight: bold; }

        /* Admin Panel */
        .admin-panel { background: #fff3cd; padding: 20px; border-radius: 10px; margin-top: 20px; border: 1px solid #ffeeba; }
    </style>
</head>
<body>

    <div class="container">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <h2 style="margin: 0;">üåç Blockchain Crowdfunding</h2>
            <div>
                <span id="walletAddress" style="font-weight:bold; margin-right: 10px;">...</span>
                <button id="connectBtn" class="btn-primary">üîå K·∫øt n·ªëi V√≠</button>
            </div>
        </div>

        <div id="homeView">
            <div id="adminCreateSection" class="admin-panel hidden" style="text-align: left;">
                <h3>‚ú® T·∫°o D·ª± √Ån M·ªõi</h3>
                <input type="text" id="newTitle" placeholder="T√™n d·ª± √°n">
                <input type="text" id="newDesc" placeholder="M√¥ t·∫£ ng·∫Øn">
                <input type="text" id="newImage" placeholder="Link ·∫£nh (URL)">
                <input type="number" id="newTarget" placeholder="M·ª•c ti√™u (ETH)">
                <button onclick="createCampaign()" class="btn-primary" style="margin-top: 10px;">T·∫°o Ngay</button>
            </div>

            <h3 id="loadingText" class="hidden">‚è≥ ƒêang t·∫£i d·ªØ li·ªáu...</h3>
            <div id="campaignGrid" class="campaign-grid"></div>
        </div>

        <div id="detailView" class="hidden">
            <button onclick="showHome()" class="btn-back">‚¨Ö Quay l·∫°i danh s√°ch</button>
            <div style="clear: both;"></div>

            <div class="detail-header">
                <img id="d-img" src="" class="detail-img">
                <div class="detail-info">
                    <h2 id="d-title" style="margin-top: 0;">T√™n d·ª± √°n</h2>
                    <span id="d-status" class="badge">Tr·∫°ng th√°i</span>
                    <p id="d-desc" style="color: #666; margin: 10px 0;">M√¥ t·∫£...</p>
                    
                    <div class="stats-grid">
                        <div class="stat-box">
                            <span style="color:#666">ƒê√£ g·ªçi v·ªën</span>
                            <span id="d-raised" class="stat-val">0 ETH</span>
                        </div>
                        <div class="stat-box">
                            <span style="color:#666">M·ª•c ti√™u</span>
                            <span id="d-target" class="stat-val">0 ETH</span>
                        </div>
                    </div>
                    <div class="progress-container">
                        <div id="d-progress" class="progress-bar"></div>
                    </div>
                </div>
            </div>

            <div id="donateArea" style="background: #e3f2fd; padding: 20px; border-radius: 10px; border: 1px solid #90caf9;">
                <h3>üíñ ·ª¶ng h·ªô d·ª± √°n n√†y</h3>
                <div style="display: flex; gap: 10px;">
                    <input type="number" id="d-amount" placeholder="S·ªë ti·ªÅn (ETH)" step="0.001" style="flex: 1;">
                    <input type="text" id="d-message" placeholder="L·ªùi nh·∫Øn g·ª≠i..." style="flex: 2;">
                    <button id="btnDonateDetail" class="btn-primary">G·ª≠i Quy√™n G√≥p üöÄ</button>
                </div>
            </div>

            <div id="adminAreaDetail" class="admin-panel hidden">
                <h3>üîê Admin Panel: R√∫t qu·ªπ d·ª± √°n n√†y</h3>
                
                <input type="text" id="w-address" placeholder="1. ƒê·ªãa ch·ªâ nh·∫≠n ti·ªÅn (0x...)" style="margin-bottom: 5px;">
                <input type="text" id="w-reason" placeholder="2. M·ª•c ƒë√≠ch r√∫t ti·ªÅn (VD: Mua g·∫°o, X√¢y c·∫ßu...)" style="margin-bottom: 5px;">
                
                <button id="btnWithdrawDetail" class="btn-danger" style="width: 100%;">üí∏ R√∫t To√†n B·ªô & Ghi S·ªï</button>
                
                <button id="btnCloseProject" class="btn-secondary" style="margin-top: 10px; width: 100%;">üîÑ ƒê√≥ng/M·ªü D·ª± √Ån n√†y</button>
            </div>

            <h3 style="margin-top: 30px;">üìú L·ªãch s·ª≠ d√≤ng ti·ªÅn</h3>
            <div class="table-wrapper">
                <table id="historyTable">
                    <thead>
                        <tr>
                            <th>Lo·∫°i</th>
                            <th>V√≠</th>
                            <th>S·ªë ti·ªÅn</th>
                            <th>N·ªôi dung</th>
                            <th>Th·ªùi gian</th>
                        </tr>
                    </thead>
                    <tbody id="historyBody"></tbody>
                </table>
            </div>
        </div>
    </div>

    <script type="module">
        import { ethers } from "https://cdnjs.cloudflare.com/ajax/libs/ethers/6.7.0/ethers.min.js";

        // üëá THAY ƒê·ªäA CH·ªà CONTRACT V2 C·ª¶A B·∫†N V√ÄO ƒê√ÇY üëá
        const CONTRACT_ADDRESS = "0x2A9e9234f00ceA40EBBE31842cfd63991ba4DA5D"; 
        
        const CONTRACT_ABI = [
    {
      "inputs": [],
      "stateMutability": "nonpayable",
      "type": "constructor"
    },
    {
      "anonymous": false,
      "inputs": [
        {
          "indexed": false,
          "internalType": "uint256",
          "name": "id",
          "type": "uint256"
        }
      ],
      "name": "CampaignClosed",
      "type": "event"
    },
    {
      "anonymous": false,
      "inputs": [
        {
          "indexed": false,
          "internalType": "uint256",
          "name": "id",
          "type": "uint256"
        },
        {
          "indexed": false,
          "internalType": "string",
          "name": "title",
          "type": "string"
        },
        {
          "indexed": false,
          "internalType": "uint256",
          "name": "target",
          "type": "uint256"
        }
      ],
      "name": "CampaignCreated",
      "type": "event"
    },
    {
      "anonymous": false,
      "inputs": [
        {
          "indexed": true,
          "internalType": "uint256",
          "name": "campaignId",
          "type": "uint256"
        },
        {
          "indexed": true,
          "internalType": "address",
          "name": "to",
          "type": "address"
        },
        {
          "indexed": false,
          "internalType": "uint256",
          "name": "amount",
          "type": "uint256"
        },
        {
          "indexed": false,
          "internalType": "string",
          "name": "reason",
          "type": "string"
        },
        {
          "indexed": false,
          "internalType": "uint256",
          "name": "timestamp",
          "type": "uint256"
        }
      ],
      "name": "FundsWithdrawn",
      "type": "event"
    },
    {
      "anonymous": false,
      "inputs": [
        {
          "indexed": true,
          "internalType": "uint256",
          "name": "campaignId",
          "type": "uint256"
        },
        {
          "indexed": true,
          "internalType": "address",
          "name": "donor",
          "type": "address"
        },
        {
          "indexed": false,
          "internalType": "uint256",
          "name": "amount",
          "type": "uint256"
        },
        {
          "indexed": false,
          "internalType": "string",
          "name": "message",
          "type": "string"
        }
      ],
      "name": "NewDonation",
      "type": "event"
    },
    {
      "inputs": [],
      "name": "campaignCount",
      "outputs": [
        {
          "internalType": "uint256",
          "name": "",
          "type": "uint256"
        }
      ],
      "stateMutability": "view",
      "type": "function"
    },
    {
      "inputs": [
        {
          "internalType": "uint256",
          "name": "",
          "type": "uint256"
        }
      ],
      "name": "campaigns",
      "outputs": [
        {
          "internalType": "uint256",
          "name": "id",
          "type": "uint256"
        },
        {
          "internalType": "address",
          "name": "creator",
          "type": "address"
        },
        {
          "internalType": "string",
          "name": "title",
          "type": "string"
        },
        {
          "internalType": "string",
          "name": "description",
          "type": "string"
        },
        {
          "internalType": "string",
          "name": "image",
          "type": "string"
        },
        {
          "internalType": "uint256",
          "name": "target",
          "type": "uint256"
        },
        {
          "internalType": "uint256",
          "name": "raised",
          "type": "uint256"
        },
        {
          "internalType": "bool",
          "name": "isOpen",
          "type": "bool"
        }
      ],
      "stateMutability": "view",
      "type": "function"
    },
    {
      "inputs": [
        {
          "internalType": "string",
          "name": "_title",
          "type": "string"
        },
        {
          "internalType": "string",
          "name": "_desc",
          "type": "string"
        },
        {
          "internalType": "string",
          "name": "_image",
          "type": "string"
        },
        {
          "internalType": "uint256",
          "name": "_target",
          "type": "uint256"
        }
      ],
      "name": "createCampaign",
      "outputs": [],
      "stateMutability": "nonpayable",
      "type": "function"
    },
    {
      "inputs": [
        {
          "internalType": "uint256",
          "name": "_id",
          "type": "uint256"
        },
        {
          "internalType": "string",
          "name": "_message",
          "type": "string"
        }
      ],
      "name": "donateToCampaign",
      "outputs": [],
      "stateMutability": "payable",
      "type": "function"
    },
    {
      "inputs": [
        {
          "internalType": "uint256",
          "name": "",
          "type": "uint256"
        }
      ],
      "name": "donations",
      "outputs": [
        {
          "internalType": "uint256",
          "name": "campaignId",
          "type": "uint256"
        },
        {
          "internalType": "address",
          "name": "donor",
          "type": "address"
        },
        {
          "internalType": "uint256",
          "name": "amount",
          "type": "uint256"
        },
        {
          "internalType": "string",
          "name": "message",
          "type": "string"
        },
        {
          "internalType": "uint256",
          "name": "timestamp",
          "type": "uint256"
        }
      ],
      "stateMutability": "view",
      "type": "function"
    },
    {
      "inputs": [],
      "name": "getAllDonations",
      "outputs": [
        {
          "components": [
            {
              "internalType": "uint256",
              "name": "campaignId",
              "type": "uint256"
            },
            {
              "internalType": "address",
              "name": "donor",
              "type": "address"
            },
            {
              "internalType": "uint256",
              "name": "amount",
              "type": "uint256"
            },
            {
              "internalType": "string",
              "name": "message",
              "type": "string"
            },
            {
              "internalType": "uint256",
              "name": "timestamp",
              "type": "uint256"
            }
          ],
          "internalType": "struct DonationDApp.Donation[]",
          "name": "",
          "type": "tuple[]"
        }
      ],
      "stateMutability": "view",
      "type": "function"
    },
    {
      "inputs": [],
      "name": "owner",
      "outputs": [
        {
          "internalType": "address",
          "name": "",
          "type": "address"
        }
      ],
      "stateMutability": "view",
      "type": "function"
    },
    {
      "inputs": [
        {
          "internalType": "uint256",
          "name": "_id",
          "type": "uint256"
        }
      ],
      "name": "toggleCampaignStatus",
      "outputs": [],
      "stateMutability": "nonpayable",
      "type": "function"
    },
    {
      "inputs": [
        {
          "internalType": "uint256",
          "name": "_id",
          "type": "uint256"
        },
        {
          "internalType": "address payable",
          "name": "_to",
          "type": "address"
        },
        {
          "internalType": "string",
          "name": "_reason",
          "type": "string"
        }
      ],
      "name": "withdrawFromCampaign",
      "outputs": [],
      "stateMutability": "nonpayable",
      "type": "function"
    }
  ];

        let provider, signer, contract, currentAddr;
        let currentCampaignId = null; // ID d·ª± √°n ƒëang xem chi ti·∫øt

        // --- 1. K·∫æT N·ªêI V√ç ---
        document.getElementById("connectBtn").onclick = async () => {
            if (!window.ethereum) return alert("C√†i MetaMask ƒëi!");
            await window.ethereum.request({ method: "eth_requestAccounts" });
            provider = new ethers.BrowserProvider(window.ethereum);
            signer = await provider.getSigner();
            currentAddr = await signer.getAddress();
            
            document.getElementById("walletAddress").innerText = currentAddr.substring(0,6) + "...";
            document.getElementById("connectBtn").classList.add("hidden");
            
            contract = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, signer);
            
            checkAdminGlobal();
            loadCampaignList();
        };

        // --- 2. LOGIC ƒêI·ªÄU H∆Ø·ªöNG (HOME <-> DETAIL) ---
        window.showHome = () => {
            document.getElementById("homeView").classList.remove("hidden");
            document.getElementById("detailView").classList.add("hidden");
            loadCampaignList(); // T·∫£i l·∫°i ƒë·ªÉ c·∫≠p nh·∫≠t s·ªë ti·ªÅn m·ªõi nh·∫•t
        };

        window.openDetail = async (id) => {
            currentCampaignId = id; // L∆∞u ID l·∫°i ƒë·ªÉ d√πng cho c√°c n√∫t Donate/R√∫t
            document.getElementById("homeView").classList.add("hidden");
            document.getElementById("detailView").classList.remove("hidden");
            
            loadDetailData(id);
        };

        // --- 3. T·∫¢I DANH S√ÅCH (HOME) ---
        async function loadCampaignList() {
            const grid = document.getElementById("campaignGrid");
            grid.innerHTML = "";
            document.getElementById("loadingText").classList.remove("hidden");

            try {
                const count = Number(await contract.campaignCount());
                
                if(count === 0) {
                    grid.innerHTML = "<p>Ch∆∞a c√≥ d·ª± √°n n√†o.</p>";
                }

                for (let i = 0; i < count; i++) {
                    const c = await contract.campaigns(i);
                    // c: [id, creator, title, desc, img, target, raised, isOpen]
                    
                    const raised = ethers.formatEther(c[6]);
                    const target = ethers.formatEther(c[5]);
                    const percent = (Number(raised) / Number(target)) * 100;
                    const isOpen = c[7];

                    const card = document.createElement("div");
                    card.className = "card";
                    // Khi b·∫•m v√†o card -> G·ªçi h√†m openDetail(id)
                    card.onclick = () => window.openDetail(i);
                    
                    card.innerHTML = `
                        <img src="${c[4]}" class="card-img" onerror="this.src='https://via.placeholder.com/300'">
                        <div class="card-body">
                            <h3 style="margin:0 0 10px;">
                                ${c[2]} 
                                <span class="badge ${isOpen ? 'open' : 'closed'}">${isOpen ? 'ƒêang m·ªü' : 'ƒê√≥ng'}</span>
                            </h3>
                            <p style="color:#666; font-size:0.9em; flex:1">${c[3].substring(0, 100)}...</p>
                            
                            <div style="margin-top:10px;">
                                <strong>${raised}</strong> / ${target} ETH
                            </div>
                            <div class="progress-container">
                                <div class="progress-bar" style="width: ${Math.min(percent, 100)}%"></div>
                            </div>
                            <button class="btn-primary" style="width:100%; margin-top:10px;">Xem Chi Ti·∫øt</button>
                        </div>
                    `;
                    grid.appendChild(card);
                }
            } catch (e) { console.error(e); }
            document.getElementById("loadingText").classList.add("hidden");
        }

        // --- 4. T·∫¢I CHI TI·∫æT (DETAIL PAGE) ---
        async function loadDetailData(id) {
            try {
                // A. T·∫£i th√¥ng tin d·ª± √°n
                const c = await contract.campaigns(id);
                document.getElementById("d-img").src = c[4];
                document.getElementById("d-title").innerText = c[2];
                document.getElementById("d-desc").innerText = c[3];
                
                const raised = ethers.formatEther(c[6]);
                const target = ethers.formatEther(c[5]);
                const percent = (Number(raised) / Number(target)) * 100;
                
                document.getElementById("d-raised").innerText = raised + " ETH";
                document.getElementById("d-target").innerText = target + " ETH";
                document.getElementById("d-progress").style.width = Math.min(percent, 100) + "%";
                
                const badge = document.getElementById("d-status");
                if (c[7]) {
                    badge.innerText = "ƒêang m·ªü quy√™n g√≥p"; badge.className = "badge open";
                    document.getElementById("donateArea").classList.remove("hidden");
                } else {
                    badge.innerText = "D·ª± √°n ƒë√£ ƒë√≥ng"; badge.className = "badge closed";
                    document.getElementById("donateArea").classList.add("hidden");
                }

                // B. Ki·ªÉm tra Admin ƒë·ªÉ hi·ªán n√∫t R√∫t ti·ªÅn
                const owner = await contract.owner();
                if (owner.toLowerCase() === currentAddr.toLowerCase()) {
                    document.getElementById("adminAreaDetail").classList.remove("hidden");
                } else {
                    document.getElementById("adminAreaDetail").classList.add("hidden");
                }

                // C. T·∫£i L·ªãch s·ª≠ (In & Out)
                renderHistoryTable(id);

            } catch (e) { console.error("L·ªói detail:", e); }
        }

        async function renderHistoryTable(campaignId) {
            const tbody = document.getElementById("historyBody");
            tbody.innerHTML = "<tr><td colspan='5'>ƒêang t·∫£i l·ªãch s·ª≠...</td></tr>";

            try {
                // 1. L·∫•y Donations (In)
                // L∆∞u √Ω: H√†m getAllDonations tr·∫£ v·ªÅ m·∫£ng t·∫•t c·∫£, ta ph·∫£i l·ªçc theo campaignId
                const allDonations = await contract.getAllDonations();
                const myDonations = allDonations
                    .filter(d => Number(d.campaignId) === campaignId)
                    .map(d => ({
                        type: 'IN',
                        who: d.donor,
                        amount: d.amount,
                        msg: d.message,
                        time: d.timestamp
                    }));

                // 2. L·∫•y Withdrawals (Out) t·ª´ Events
                // Filter event FundsWithdrawn(campaignId, to, amount)
                // ·ªû ƒë√¢y d√πng queryFilter c∆° b·∫£n, n·∫øu ph·ª©c t·∫°p c·∫ßn filter theo topic
                const filter = contract.filters.FundsWithdrawn(campaignId); 
                const events = await contract.queryFilter(filter);
                const myWithdraws = events.map(ev => ({
                    type: 'OUT',
                    who: ev.args[1], // address to
                    amount: ev.args[2], // amount
                    msg: "R√∫t qu·ªπ d·ª± √°n",
                    time: (Date.now() / 1000) // Timestamp event h∆°i kh√≥ l·∫•y ch√≠nh x√°c ngay, d√πng t·∫°m time hi·ªán t·∫°i ho·∫∑c ph·∫£i getBlock
                }));

                // 3. G·ªôp v√† s·∫Øp x·∫øp
                const combined = [...myDonations, ...myWithdraws].reverse(); // M·ªõi nh·∫•t l√™n ƒë·∫ßu (gi·∫£ l·∫≠p)

                tbody.innerHTML = "";
                if (combined.length === 0) tbody.innerHTML = "<tr><td colspan='5'>Ch∆∞a c√≥ giao d·ªãch n√†o.</td></tr>";

                combined.forEach(t => {
                    const isIn = t.type === 'IN';
                    tbody.innerHTML += `
                        <tr class="${isIn ? 'tx-in' : 'tx-out'}">
                            <td>${isIn ? 'üì• Nh·∫≠n' : 'üì§ R√∫t'}</td>
                            <td>${t.who.substring(0,6)}...</td>
                            <td class="${isIn ? 'money-in' : 'money-out'}">${isIn ? '+' : '-'} ${ethers.formatEther(t.amount)}</td>
                            <td>${t.msg}</td>
                            <td>${isIn ? new Date(Number(t.time)*1000).toLocaleString() : 'Recent'}</td>
                        </tr>
                    `;
                });

            } catch(e) { console.error(e); }
        }

        // --- C√ÅC H√ÄM T∆Ø∆†NG T√ÅC ---
        
        // 1. T·∫°o d·ª± √°n (G·ªçi t·ª´ Home)
        window.createCampaign = async () => {
            const t = document.getElementById("newTitle").value;
            const d = document.getElementById("newDesc").value;
            const i = document.getElementById("newImage").value;
            const v = document.getElementById("newTarget").value;
            if(!t || !v) return alert("Nh·∫≠p ƒë·ªß th√¥ng tin!");
            
            try {
                const tx = await contract.createCampaign(t, d, i, ethers.parseEther(v));
                await tx.wait();
                alert("ƒê√£ t·∫°o d·ª± √°n!");
                loadCampaignList();
            } catch(e) { alert("L·ªói: " + e.message); }
        };

        // 2. Quy√™n g√≥p (G·ªçi t·ª´ Detail)
        document.getElementById("btnDonateDetail").onclick = async () => {
            const amt = document.getElementById("d-amount").value;
            const msg = document.getElementById("d-message").value;
            if(!amt) return alert("Nh·∫≠p s·ªë ti·ªÅn!");

            try {
                const tx = await contract.donateToCampaign(currentCampaignId, msg, { value: ethers.parseEther(amt) });
                alert("ƒêang x·ª≠ l√Ω...");
                await tx.wait();
                alert("C·∫£m ∆°n b·∫°n ƒë√£ quy√™n g√≥p!");
                loadDetailData(currentCampaignId); // T·∫£i l·∫°i chi ti·∫øt
            } catch(e) { alert("L·ªói: " + e.message); }
        };

        // 3. R√∫t ti·ªÅn (G·ªçi t·ª´ Detail - Admin)
        document.getElementById("btnWithdrawDetail").onclick = async () => {
            const to = document.getElementById("w-address").value;
            if(!to) return alert("Nh·∫≠p ƒë·ªãa ch·ªâ nh·∫≠n!");

            try {
                const tx = await contract.withdrawFromCampaign(currentCampaignId, to);
                alert("ƒêang r√∫t ti·ªÅn...");
                await tx.wait();
                alert("R√∫t th√†nh c√¥ng!");
                loadDetailData(currentCampaignId);
            } catch(e) { alert("L·ªói: " + e.message); }
        };

        // 4. ƒê√≥ng/M·ªü d·ª± √°n
        document.getElementById("btnCloseProject").onclick = async () => {
             try {
                const tx = await contract.toggleCampaignStatus(currentCampaignId);
                await tx.wait();
                loadDetailData(currentCampaignId);
            } catch(e) { alert("L·ªói: " + e.message); }
        };

        // Utility: Check Admin Global
        async function checkAdminGlobal() {
            try {
                const owner = await contract.owner();
                if (owner.toLowerCase() === currentAddr.toLowerCase()) {
                    document.getElementById("adminCreateSection").classList.remove("hidden");
                }
            } catch(e) {}
        }

    </script>
</body>
</html>